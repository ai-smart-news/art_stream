<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的短影音</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            color: white;
        }

        .app-wrapper {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            max-height: 900px;
            position: relative;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .video-feed {
            width: 100%;
            height: 100%;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            position: relative;
            scrollbar-width: none;
        }

        .video-feed::-webkit-scrollbar {
            display: none;
        }

        .video-card {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            scroll-snap-align: start;
            position: relative;
            background: #000;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            position: absolute;
            top: 0;
            left: 0;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(0,0,0,0.1) 0%,
                rgba(0,0,0,0) 20%,
                rgba(0,0,0,0) 60%,
                rgba(0,0,0,0.7) 100%
            );
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 25px;
            z-index: 1;
        }

        .side-actions {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
            z-index: 3;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn i {
            font-size: 2em;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .action-btn:hover i {
            transform: scale(1.2);
        }

        .action-btn:nth-child(1) i {
            color: #ff3040;
        }

        .action-btn:nth-child(2) i {
            color: #25d366;
        }

        .action-btn:nth-child(3) i {
            color: #1da1f2;
        }

        .play-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            color: rgba(255, 255, 255, 0.9);
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 4;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
        }

        .video-card.paused .play-indicator {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Loading animation */
        .video-card.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 5;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Progress bar */
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            width: 100%;
            z-index: 2;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff3040, #ff6b6b);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Hide default video controls */
        video::-webkit-media-controls,
        video::-webkit-media-controls-enclosure {
            display: none !important;
        }

        video {
            -ms-media-controls-display: none;
            -moz-appearance: none;
            -webkit-appearance: none;
        }

        /* End of content indicator */
        .end-indicator {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #000;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            padding: 40px;
        }

        .end-indicator i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .end-indicator h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .end-indicator p {
            font-size: 1em;
            opacity: 0.7;
        }

        /* Mobile responsive */
        @media (max-width: 480px) {
            .app-wrapper {
                max-width: 100vw;
                height: 100vh;
                border-radius: 0;
                border: none;
            }

            .video-overlay {
                padding: 20px;
            }

            .side-actions {
                right: 15px;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="video-feed">
            <!-- Videos will be dynamically loaded here -->
        </div>
    </div>

    <script>
        class VideoApp {
            constructor() {
                this.videoFeed = document.querySelector('.video-feed');
                this.allVideos = []; // 所有影片的扁平化陣列
                this.currentVideoIndex = 0;
                this.renderedVideos = new Map(); // 已渲染的影片 Map<index, element>
                this.observer = null;
                this.loadedDates = new Set(); // 已載入的日期
                this.isLoading = false;
                this.hasMoreContent = true;
                
                this.init();
            }

            // 取得當前日期，格式：2025_09_08
            getCurrentDateString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}_${month}_${day}`;
            }

            // 取得前一天的日期字串
            getPreviousDateString(dateString) {
                const [year, month, day] = dateString.split('_');
                const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                date.setDate(date.getDate() - 1);
                
                const prevYear = date.getFullYear();
                const prevMonth = String(date.getMonth() + 1).padStart(2, '0');
                const prevDay = String(date.getDate()).padStart(2, '0');
                return `${prevYear}_${prevMonth}_${prevDay}`;
            }

            // 載入指定日期的 JSON 數據
            async loadDateData(dateString) {
                if (this.loadedDates.has(dateString)) {
                    return [];
                }

                try {
                    const response = await fetch(`videos/${dateString}/data.json`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.loadedDates.add(dateString);
                    
                    // 轉換數據格式
                    return data.videos.map((video, index) => ({
                        id: `${dateString}_${index + 1}`,
                        src: video.filename,
                        thumb: video.thumb_path,
                        timestamp: video.timestamp,
                        date: dateString
                    }));
                } catch (error) {
                    console.log(`無法載入 ${dateString} 的數據:`, error);
                    return null;
                }
            }

            // 載入更多影片數據
            async loadMoreVideos() {
                if (this.isLoading || !this.hasMoreContent) return;
                
                this.isLoading = true;
                let dateToLoad = this.getCurrentDateString();
                
                // 如果已經有載入的日期，從最早的日期開始往前找
                if (this.loadedDates.size > 0) {
                    const sortedDates = Array.from(this.loadedDates).sort();
                    dateToLoad = this.getPreviousDateString(sortedDates[0]);
                }

                let maxAttempts = 30; // 最多嘗試30天
                let attempts = 0;

                while (attempts < maxAttempts) {
                    const newVideos = await this.loadDateData(dateToLoad);
                    
                    if (newVideos && newVideos.length > 0) {
                        // 將新影片插入到陣列開頭
                        this.allVideos.unshift(...newVideos);
                        // 調整當前索引
                        this.currentVideoIndex += newVideos.length;
                        this.isLoading = false;
                        return newVideos.length;
                    } else if (newVideos === null) {
                        // 載入失敗，嘗試前一天
                        dateToLoad = this.getPreviousDateString(dateToLoad);
                        attempts++;
                    } else {
                        // 空陣列，繼續嘗試前一天
                        dateToLoad = this.getPreviousDateString(dateToLoad);
                        attempts++;
                    }
                }

                // 達到最大嘗試次數，沒有更多內容
                this.hasMoreContent = false;
                this.isLoading = false;
                return 0;
            }

            // 初始化載入
            async init() {
                // 載入今天的影片
                await this.loadMoreVideos();
                
                if (this.allVideos.length === 0) {
                    this.showEndIndicator();
                    return;
                }

                this.updateRenderedVideos();
                this.scrollToCurrentVideo();
                this.setupKeyboardEvents();
            }

            // 顯示結束指示器
            showEndIndicator() {
                this.videoFeed.innerHTML = `
                    <div class="video-card">
                        <div class="end-indicator">
                            <i class="fas fa-film"></i>
                            <h3>暫無更多影片</h3>
                            <p>請稍後再來查看新內容</p>
                        </div>
                    </div>
                `;
            }

            // 創建進度條
            createProgressBar() {
                const progressBar = document.createElement('div');
                progressBar.classList.add('progress-bar');
                const progressFill = document.createElement('div');
                progressFill.classList.add('progress-fill');
                progressBar.appendChild(progressFill);
                return progressBar;
            }

            // 更新進度條
            updateProgressBar(video, progressFill) {
                if (video.duration) {
                    const progress = (video.currentTime / video.duration) * 100;
                    progressFill.style.width = `${progress}%`;
                }
            }

            // 創建單個影片卡片
            createVideoCard(videoItem, index) {
                const videoCard = document.createElement('div');
                videoCard.classList.add('video-card', 'loading');
                videoCard.dataset.index = index;

                const videoPlayer = document.createElement('video');
                videoPlayer.classList.add('video-player');
                videoPlayer.src = videoItem.src;
                videoPlayer.loop = true;
                videoPlayer.muted = true;
                videoPlayer.playsInline = true;
                videoPlayer.preload = 'metadata';

                const videoOverlay = document.createElement('div');
                videoOverlay.classList.add('video-overlay');

                const sideActions = document.createElement('div');
                sideActions.classList.add('side-actions');
                const likeBtn = document.createElement('div');
                likeBtn.classList.add('action-btn');
                likeBtn.innerHTML = '<i class="fas fa-heart"></i><span>1.2M</span>';
                const commentBtn = document.createElement('div');
                commentBtn.classList.add('action-btn');
                commentBtn.innerHTML = '<i class="fas fa-comment-dots"></i><span>5.7K</span>';
                const shareBtn = document.createElement('div');
                shareBtn.classList.add('action-btn');
                shareBtn.innerHTML = '<i class="fas fa-share"></i><span>分享</span>';
                sideActions.appendChild(likeBtn);
                sideActions.appendChild(commentBtn);
                sideActions.appendChild(shareBtn);

                const playIndicator = document.createElement('div');
                playIndicator.classList.add('play-indicator');
                playIndicator.innerHTML = '<i class="fas fa-play"></i>';

                const progressBar = this.createProgressBar();
                const progressFill = progressBar.querySelector('.progress-fill');

                videoCard.appendChild(videoPlayer);
                videoCard.appendChild(videoOverlay);
                videoCard.appendChild(sideActions);
                videoCard.appendChild(playIndicator);
                videoCard.appendChild(progressBar);

                // 影片載入完成事件
                videoPlayer.addEventListener('loadedmetadata', () => {
                    videoCard.classList.remove('loading');
                });

                // 進度更新
                videoPlayer.addEventListener('timeupdate', () => {
                    this.updateProgressBar(videoPlayer, progressFill);
                });

                // 點擊影片播放/暫停
                videoPlayer.addEventListener('click', () => {
                    this.togglePlayPause(videoPlayer, videoCard, playIndicator);
                });

                // 按讚動畫
                likeBtn.addEventListener('click', () => {
                    likeBtn.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        likeBtn.style.transform = 'scale(1)';
                    }, 200);
                });

                videoCard.classList.add('paused');
                return videoCard;
            }

            // 播放/暫停功能
            togglePlayPause(video, card, indicator) {
                if (video.paused) {
                    video.play().catch(e => console.error("Play error:", e));
                    card.classList.remove('paused');
                    indicator.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    video.pause();
                    card.classList.add('paused');
                    indicator.innerHTML = '<i class="fas fa-play"></i>';
                }
                
                indicator.style.opacity = 1;
                clearTimeout(video.indicatorTimeout);
                video.indicatorTimeout = setTimeout(() => {
                    indicator.style.opacity = 0;
                }, 800);
            }

            // 計算需要渲染的影片範圍
            getVideoRange() {
                const current = this.currentVideoIndex;
                
                if (current === 0) {
                    // 在第1支影片：preload 2+3
                    return { start: 0, end: Math.min(2, this.allVideos.length - 1) };
                } else if (current === 1) {
                    // 在第2支影片：保留1，preload 3+4
                    return { start: 0, end: Math.min(3, this.allVideos.length - 1) };
                } else {
                    // 第3支以後：保留前2支，preload 後2支
                    const start = Math.max(0, current - 2);
                    const end = Math.min(current + 2, this.allVideos.length - 1);
                    return { start, end };
                }
            }

            // 更新渲染的影片
            updateRenderedVideos() {
                const { start, end } = this.getVideoRange();
                
                // 移除不在範圍內的影片
                for (const [index, element] of this.renderedVideos.entries()) {
                    if (index < start || index > end) {
                        element.remove();
                        this.renderedVideos.delete(index);
                    }
                }

                // 添加需要的影片
                for (let i = start; i <= end; i++) {
                    if (!this.renderedVideos.has(i) && this.allVideos[i]) {
                        const videoCard = this.createVideoCard(this.allVideos[i], i);
                        this.renderedVideos.set(i, videoCard);
                    }
                }

                // 重新排序並添加到 DOM
                this.videoFeed.innerHTML = '';
                for (let i = start; i <= end; i++) {
                    if (this.renderedVideos.has(i)) {
                        this.videoFeed.appendChild(this.renderedVideos.get(i));
                    }
                }

                this.initObserver();
                
                // 檢查是否需要載入更多內容
                if (this.currentVideoIndex < 5 && this.hasMoreContent) {
                    this.loadMoreVideos().then(newCount => {
                        if (newCount > 0) {
                            this.updateRenderedVideos();
                        }
                    });
                }
            }

            // 滾動到當前影片
            scrollToCurrentVideo() {
                const currentCard = this.renderedVideos.get(this.currentVideoIndex);
                if (currentCard) {
                    const cardIndex = Array.from(this.videoFeed.children).indexOf(currentCard);
                    this.videoFeed.scrollTo({
                        top: cardIndex * this.videoFeed.clientHeight,
                        behavior: 'smooth'
                    });
                }
            }

            // 初始化觀察器
            initObserver() {
                if (this.observer) this.observer.disconnect();

                const options = {
                    root: this.videoFeed,
                    rootMargin: '0px',
                    threshold: 0.8
                };

                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const videoCard = entry.target;
                        const video = videoCard.querySelector('.video-player');
                        const index = parseInt(videoCard.dataset.index);
                        const playIndicator = videoCard.querySelector('.play-indicator');

                        if (entry.isIntersecting && index === this.currentVideoIndex) {
                            // 當前影片進入視窗
                            video.play().catch(e => console.error("Play error:", e));
                            videoCard.classList.remove('paused');
                            playIndicator.innerHTML = '<i class="fas fa-pause"></i>';
                        } else {
                            // 其他影片暫停
                            video.pause();
                            videoCard.classList.add('paused');
                            playIndicator.innerHTML = '<i class="fas fa-play"></i>';
                        }
                    });
                }, options);

                this.videoFeed.querySelectorAll('.video-card').forEach(card => {
                    this.observer.observe(card);
                });
            }

            // 切換到指定影片
            switchToVideo(newIndex) {
                if (newIndex < 0 || newIndex >= this.allVideos.length) return;
                
                this.currentVideoIndex = newIndex;
                this.updateRenderedVideos();
                this.scrollToCurrentVideo();
            }

            // 設置鍵盤事件
            setupKeyboardEvents() {
                document.addEventListener('keydown', (e) => {
                    const currentCard = this.renderedVideos.get(this.currentVideoIndex);
                    if (!currentCard) return;

                    const video = currentCard.querySelector('.video-player');
                    const playIndicator = currentCard.querySelector('.play-indicator');

                    switch (e.code) {
                        case 'Space':
                            e.preventDefault();
                            this.togglePlayPause(video, currentCard, playIndicator);
                            break;
                        case 'ArrowDown':
                        case 'PageDown':
                            e.preventDefault();
                            this.switchToVideo(this.currentVideoIndex + 1);
                            break;
                        case 'ArrowUp':
                        case 'PageUp':
                            e.preventDefault();
                            this.switchToVideo(this.currentVideoIndex - 1);
                            break;
                    }
                });
            }
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            new VideoApp();
        });
    </script>
</body>
</html>
